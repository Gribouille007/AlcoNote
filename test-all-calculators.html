<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test Final - Tous les Calculateurs</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 5px 0; border-radius: 3px; }
        .error { background: #ffe6e6; }
        .success { background: #e6ffe6; }
        .warning { background: #fff3cd; }
    </style>
</head>
<body>
    <h1>Test Final - Tous les Calculateurs</h1>
    <div id="debug-output"></div>

    <script src="js/utils.js"></script>
    <script src="js/database.js"></script>
    <script src="js/stats-calculators/general.js"></script>
    <script src="js/stats-calculators/categories.js"></script>
    <script src="js/stats-calculators/drinks.js"></script>
    <script src="js/stats-calculators/health.js"></script>
    <script src="js/stats-calculators/temporal.js"></script>
    <script src="js/stats-calculators/location.js"></script>
    <script src="js/statistics.js"></script>

    <script>
        const testData = {
            drinks: [
                {
                    id: 1,
                    name: 'Heineken',
                    category: 'Bière',
                    quantity: 1,
                    unit: 'EcoCup',
                    alcoholContent: 5,
                    date: '2025-09-29',
                    time: '18:00'
                },
                {
                    id: 2,
                    name: 'Leffe',
                    category: 'Bière',
                    quantity: 1,
                    unit: 'EcoCup',
                    alcoholContent: 6.6,
                    date: '2025-09-29',
                    time: '19:00'
                }
            ],
            settings: { userWeight: 70, userGender: 'male' }
        };

        function debug(message, type = 'info') {
            const output = document.getElementById('debug-output');
            const div = document.createElement('div');
            div.className = `debug ${type}`;
            div.innerHTML = `${message}`;
            output.appendChild(div);
        }

        // Mock all dependencies
        window.dbManager = {
            getDrinksByDateRange: async (startDate, endDate) => {
                debug(`Mock: getDrinksByDateRange(${startDate}, ${endDate})`);
                return testData.drinks;
            },
            getAllSettings: async () => {
                debug('Mock: getAllSettings()');
                return testData.settings;
            },
            getAllDrinks: async () => {
                return testData.drinks;
            }
        };

        window.geoManager = {
            getLocationStats: async (drinks) => {
                debug(`Mock: geoManager.getLocationStats(${drinks.length} drinks)`);
                return { hasLocationData: false, message: 'Test', stats: null };
            }
        };

        async function testComprehensiveStats() {
            debug('=== TEST FINAL: calculateComprehensiveStats ===');
            
            const drinks = testData.drinks;
            const dateRange = { start: '2025-09-29', end: '2025-09-29' };

            try {
                if (!window.statsManager) {
                    debug('❌ statsManager NON DISPONIBLE', 'error');
                    return;
                }

                debug('✅ statsManager disponible', 'success');

                // Appel direct de calculateComprehensiveStats
                debug('Appel de calculateComprehensiveStats...', 'warning');
                
                const stats = await window.statsManager.calculateComprehensiveStats(drinks, dateRange);
                
                debug('✅ calculateComprehensiveStats réussi!', 'success');
                debug(`Résultat: ${JSON.stringify(Object.keys(stats))}`, 'success');
                
                // Vérification de chaque section
                if (stats.general) debug('✅ stats.general OK', 'success');
                else debug('❌ stats.general MANQUANT', 'error');
                
                if (stats.temporal) debug('✅ stats.temporal OK', 'success');  
                else debug('❌ stats.temporal MANQUANT', 'error');
                
                if (stats.categories) debug('✅ stats.categories OK', 'success');
                else debug('❌ stats.categories MANQUANT', 'error');
                
                if (stats.individualDrinks) debug('✅ stats.individualDrinks OK', 'success');
                else debug('❌ stats.individualDrinks MANQUANT', 'error');
                
                if (stats.health) debug('✅ stats.health OK', 'success');
                else debug('❌ stats.health MANQUANT', 'error');
                
                if (stats.location) debug('✅ stats.location OK', 'success');
                else debug('❌ stats.location MANQUANT', 'error');

                debug('=== DÉTAILS ===', 'warning');
                debug(`General: totalDrinks=${stats.general?.totalDrinks}`, 'info');
                debug(`Health: totalAlcoholGrams=${stats.health?.totalAlcoholGrams}`, 'info');
                debug(`Temporal: totalSessions=${stats.temporal?.totalSessions}`, 'info');

            } catch (error) {
                debug(`❌ ERREUR dans calculateComprehensiveStats: ${error.message}`, 'error');
                debug(`Stack: ${error.stack}`, 'error');
                console.error('Erreur complète:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(testComprehensiveStats, 1000);
        });
    </script>
</body>
</html>
