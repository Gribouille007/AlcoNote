<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test BAC Calculations</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            background-color: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid #444;
        }
        .result {
            background-color: #0066cc;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background-color: #cc0000;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background-color: #00cc66;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0052a3;
        }
    </style>
</head>
<body>
    <h1>üç∫ Test des calculs d'alcool√©mie - AlcoNote</h1>
    
    <div class="test-section">
        <h2>Test 1: Calcul de base (Homme 70kg, 1 bi√®re 25cL √† 5%)</h2>
        <p><strong>Sc√©nario:</strong> Homme de 70kg boit 1 bi√®re de 25cL √† 5% il y a 2 heures</p>
        <p><strong>Calcul attendu:</strong></p>
        <ul>
            <li>Alcool ing√©r√©: 25 √ó 5 √ó 0,8 √∑ 10 = 10g</li>
            <li>BAC initial: 10 √∑ (70 √ó 0,68) = 0,210 g/L = 210 mg/L</li>
            <li>Apr√®s 2h d'√©limination: 210 - (0,15 √ó 1000 √ó 2) = 210 - 300 = 0 mg/L (max 0)</li>
        </ul>
        <button onclick="testBasicBAC()">Tester</button>
        <div id="test1-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Calcul r√©cent (Homme 70kg, 1 bi√®re il y a 30 min)</h2>
        <p><strong>Sc√©nario:</strong> Homme de 70kg boit 1 bi√®re de 25cL √† 5% il y a 30 minutes</p>
        <p><strong>Calcul attendu:</strong></p>
        <ul>
            <li>Alcool ing√©r√©: 10g</li>
            <li>BAC initial: 210 mg/L</li>
            <li>Apr√®s 0,5h: 210 - (150 √ó 0,5) = 210 - 75 = 135 mg/L</li>
        </ul>
        <button onclick="testRecentBAC()">Tester</button>
        <div id="test2-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Calculs de temps</h2>
        <p><strong>Sc√©nario:</strong> BAC actuel de 300 mg/L</p>
        <p><strong>Temps attendus:</strong></p>
        <ul>
            <li>Sobri√©t√© (0 mg/L): 300 √∑ 150 = 2h</li>
            <li>Limite l√©gale (500 mg/L): D√©j√† sous la limite = 0h</li>
        </ul>
        <button onclick="testTimeCalculations()">Tester</button>
        <div id="test3-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 4: Calculs de temps (BAC √©lev√©)</h2>
        <p><strong>Sc√©nario:</strong> BAC actuel de 800 mg/L</p>
        <p><strong>Temps attendus:</strong></p>
        <ul>
            <li>Sobri√©t√© (0 mg/L): 800 √∑ 150 = 5,33h ‚âà 5h 20min</li>
            <li>Limite l√©gale (500 mg/L): (800-500) √∑ 150 = 2h</li>
        </ul>
        <button onclick="testHighBACTime()">Tester</button>
        <div id="test4-result"></div>
    </div>

    <script>
        // Copy the Utils class from the main app
        class Utils {
            static convertToStandardUnit(quantity, unit) {
                switch (unit) {
                    case 'EcoCup':
                        return { quantity: 25, unit: 'cL' };
                    case 'L':
                        return { quantity: quantity * 100, unit: 'cL' };
                    case 'cL':
                    default:
                        return { quantity, unit: 'cL' };
                }
            }
            
            static calculateAlcoholGrams(volumeCL, alcoholPercent) {
                return (volumeCL * alcoholPercent * 0.8) / 10;
            }
            
            static calculateCurrentBAC(drinks, weightKg, gender, currentTime = new Date()) {
                if (!drinks || drinks.length === 0 || !weightKg || !gender) {
                    return 0;
                }
                
                const r = gender === 'female' ? 0.55 : 0.68;
                let totalAlcoholGrams = 0;
                let earliestDrinkTime = null;
                
                drinks.forEach(drink => {
                    const volumeInCL = this.convertToStandardUnit(drink.quantity, drink.unit).quantity;
                    const alcoholGrams = this.calculateAlcoholGrams(volumeInCL, drink.alcoholContent || 0);
                    totalAlcoholGrams += alcoholGrams;
                    
                    const drinkDateTime = new Date(`${drink.date}T${drink.time}`);
                    if (!earliestDrinkTime || drinkDateTime < earliestDrinkTime) {
                        earliestDrinkTime = drinkDateTime;
                    }
                });
                
                const peakBACGL = totalAlcoholGrams / (weightKg * r);
                const hoursElapsed = earliestDrinkTime ? 
                    Math.max(0, (currentTime - earliestDrinkTime) / (1000 * 60 * 60)) : 0;
                const currentBACGL = Math.max(0, peakBACGL - (0.15 * hoursElapsed));
                
                return currentBACGL * 1000; // Convert to mg/L
            }
            
            static calculateTimeToBAC(currentBACMgL, targetBACMgL = 0) {
                if (currentBACMgL <= targetBACMgL) {
                    return 0;
                }
                
                const currentBACGL = currentBACMgL / 1000;
                const targetBACGL = targetBACMgL / 1000;
                
                const hoursNeeded = (currentBACGL - targetBACGL) / 0.15;
                return Math.max(0, hoursNeeded);
            }
            
            static formatTimeToSobriety(hours) {
                if (hours <= 0) {
                    return "Maintenant";
                }
                
                const wholeHours = Math.floor(hours);
                const minutes = Math.round((hours - wholeHours) * 60);
                
                if (wholeHours === 0) {
                    return `${minutes} min`;
                } else if (minutes === 0) {
                    return `${wholeHours}h`;
                } else {
                    return `${wholeHours}h ${minutes}min`;
                }
            }
        }
        
        function testBasicBAC() {
            const resultDiv = document.getElementById('test1-result');
            
            try {
                // Create test drink: 1 beer 25cL at 5%, consumed 2 hours ago
                const now = new Date();
                const twoHoursAgo = new Date(now.getTime() - (2 * 60 * 60 * 1000));
                
                const drinks = [{
                    quantity: 1,
                    unit: 'EcoCup', // 25cL
                    alcoholContent: 5,
                    date: twoHoursAgo.toISOString().split('T')[0],
                    time: twoHoursAgo.toTimeString().slice(0, 5)
                }];
                
                const bac = Utils.calculateCurrentBAC(drinks, 70, 'male', now);
                const timeToSobriety = Utils.calculateTimeToBAC(bac, 0);
                const timeToLegal = Utils.calculateTimeToBAC(bac, 500);
                
                resultDiv.innerHTML = `
                    <div class="result">
                        <strong>R√©sultats:</strong><br>
                        BAC actuel: ${bac.toFixed(1)} mg/L<br>
                        Temps pour sobri√©t√©: ${Utils.formatTimeToSobriety(timeToSobriety)}<br>
                        Temps pour limite l√©gale: ${Utils.formatTimeToSobriety(timeToLegal)}<br>
                        <br>
                        <strong>D√©tails du calcul:</strong><br>
                        Alcool ing√©r√©: ${Utils.calculateAlcoholGrams(25, 5).toFixed(1)}g<br>
                        BAC initial: ${(Utils.calculateAlcoholGrams(25, 5) / (70 * 0.68) * 1000).toFixed(1)} mg/L<br>
                        √âlimination 2h: ${(0.15 * 2 * 1000).toFixed(0)} mg/L<br>
                        BAC final: max(0, ${(Utils.calculateAlcoholGrams(25, 5) / (70 * 0.68) * 1000).toFixed(1)} - ${(0.15 * 2 * 1000).toFixed(0)}) = ${bac.toFixed(1)} mg/L
                    </div>
                `;
                
                if (bac === 0) {
                    resultDiv.innerHTML += '<div class="success">‚úÖ Test r√©ussi: BAC correctement calcul√© √† 0 apr√®s 2h</div>';
                } else {
                    resultDiv.innerHTML += '<div class="error">‚ùå Erreur: BAC devrait √™tre 0 apr√®s 2h d\'√©limination</div>';
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Erreur: ${error.message}</div>`;
            }
        }
        
        function testRecentBAC() {
            const resultDiv = document.getElementById('test2-result');
            
            try {
                // Create test drink: 1 beer 25cL at 5%, consumed 30 minutes ago
                const now = new Date();
                const thirtyMinAgo = new Date(now.getTime() - (30 * 60 * 1000));
                
                const drinks = [{
                    quantity: 1,
                    unit: 'EcoCup', // 25cL
                    alcoholContent: 5,
                    date: thirtyMinAgo.toISOString().split('T')[0],
                    time: thirtyMinAgo.toTimeString().slice(0, 5)
                }];
                
                const bac = Utils.calculateCurrentBAC(drinks, 70, 'male', now);
                const timeToSobriety = Utils.calculateTimeToBAC(bac, 0);
                const timeToLegal = Utils.calculateTimeToBAC(bac, 500);
                
                const expectedBAC = Math.max(0, (Utils.calculateAlcoholGrams(25, 5) / (70 * 0.68) * 1000) - (0.15 * 0.5 * 1000));
                
                resultDiv.innerHTML = `
                    <div class="result">
                        <strong>R√©sultats:</strong><br>
                        BAC actuel: ${bac.toFixed(1)} mg/L<br>
                        BAC attendu: ${expectedBAC.toFixed(1)} mg/L<br>
                        Temps pour sobri√©t√©: ${Utils.formatTimeToSobriety(timeToSobriety)}<br>
                        Temps pour limite l√©gale: ${Utils.formatTimeToSobriety(timeToLegal)}<br>
                        <br>
                        <strong>D√©tails du calcul:</strong><br>
                        Alcool ing√©r√©: ${Utils.calculateAlcoholGrams(25, 5).toFixed(1)}g<br>
                        BAC initial: ${(Utils.calculateAlcoholGrams(25, 5) / (70 * 0.68) * 1000).toFixed(1)} mg/L<br>
                        √âlimination 0,5h: ${(0.15 * 0.5 * 1000).toFixed(0)} mg/L<br>
                        BAC final: ${bac.toFixed(1)} mg/L
                    </div>
                `;
                
                if (Math.abs(bac - expectedBAC) < 1) {
                    resultDiv.innerHTML += '<div class="success">‚úÖ Test r√©ussi: BAC correctement calcul√©</div>';
                } else {
                    resultDiv.innerHTML += '<div class="error">‚ùå Erreur: BAC calcul√© ne correspond pas √† l\'attendu</div>';
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Erreur: ${error.message}</div>`;
            }
        }
        
        function testTimeCalculations() {
            const resultDiv = document.getElementById('test3-result');
            
            try {
                const currentBAC = 300; // mg/L
                const timeToSobriety = Utils.calculateTimeToBAC(currentBAC, 0);
                const timeToLegal = Utils.calculateTimeToBAC(currentBAC, 500);
                
                resultDiv.innerHTML = `
                    <div class="result">
                        <strong>R√©sultats:</strong><br>
                        BAC actuel: ${currentBAC} mg/L<br>
                        Temps pour sobri√©t√© (0 mg/L): ${Utils.formatTimeToSobriety(timeToSobriety)}<br>
                        Temps pour limite l√©gale (500 mg/L): ${Utils.formatTimeToSobriety(timeToLegal)}<br>
                        <br>
                        <strong>Calculs:</strong><br>
                        Sobri√©t√©: (300 - 0) √∑ 150 = ${timeToSobriety.toFixed(2)}h<br>
                        Limite l√©gale: max(0, (300 - 500) √∑ 150) = ${timeToLegal.toFixed(2)}h
                    </div>
                `;
                
                if (Math.abs(timeToSobriety - 2) < 0.1 && timeToLegal === 0) {
                    resultDiv.innerHTML += '<div class="success">‚úÖ Test r√©ussi: Temps correctement calcul√©s</div>';
                } else {
                    resultDiv.innerHTML += '<div class="error">‚ùå Erreur: Temps calcul√©s incorrects</div>';
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Erreur: ${error.message}</div>`;
            }
        }
        
        function testHighBACTime() {
            const resultDiv = document.getElementById('test4-result');
            
            try {
                const currentBAC = 800; // mg/L
                const timeToSobriety = Utils.calculateTimeToBAC(currentBAC, 0);
                const timeToLegal = Utils.calculateTimeToBAC(currentBAC, 500);
                
                resultDiv.innerHTML = `
                    <div class="result">
                        <strong>R√©sultats:</strong><br>
                        BAC actuel: ${currentBAC} mg/L<br>
                        Temps pour sobri√©t√© (0 mg/L): ${Utils.formatTimeToSobriety(timeToSobriety)}<br>
                        Temps pour limite l√©gale (500 mg/L): ${Utils.formatTimeToSobriety(timeToLegal)}<br>
                        <br>
                        <strong>Calculs:</strong><br>
                        Sobri√©t√©: (800 - 0) √∑ 150 = ${timeToSobriety.toFixed(2)}h<br>
                        Limite l√©gale: (800 - 500) √∑ 150 = ${timeToLegal.toFixed(2)}h
                    </div>
                `;
                
                const expectedSobriety = 800 / 150; // ‚âà 5.33h
                const expectedLegal = (800 - 500) / 150; // = 2h
                
                if (Math.abs(timeToSobriety - expectedSobriety) < 0.1 && Math.abs(timeToLegal - expectedLegal) < 0.1) {
                    resultDiv.innerHTML += '<div class="success">‚úÖ Test r√©ussi: Temps correctement calcul√©s</div>';
                } else {
                    resultDiv.innerHTML += '<div class="error">‚ùå Erreur: Temps calcul√©s incorrects</div>';
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Erreur: ${error.message}</div>`;
            }
        }
        
        function runAllTests() {
            testBasicBAC();
            setTimeout(() => testRecentBAC(), 100);
            setTimeout(() => testTimeCalculations(), 200);
            setTimeout(() => testHighBACTime(), 300);
        }
        
        // Auto-run tests on page load
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
    
    <div class="test-section">
        <h2>üß™ Tests automatiques</h2>
        <button onclick="runAllTests()">Lancer tous les tests</button>
        <p><em>Les tests se lancent automatiquement au chargement de la page.</em></p>
    </div>
    
    <div class="test-section">
        <h2>üìã R√©sum√© des corrections</h2>
        <p><strong>Probl√®mes corrig√©s:</strong></p>
        <ul>
            <li>‚úÖ Formule alcool: Correction de calculateAlcoholGrams (√∑10 au lieu de √∑100)</li>
            <li>‚úÖ Calcul BAC: Somme totale de l'alcool puis √©limination depuis le premier verre</li>
            <li>‚úÖ Unit√©s: Toutes les valeurs en mg/L (multiplication par 1000)</li>
            <li>‚úÖ Limite l√©gale: 500 mg/L pour la Belgique (conduite g√©n√©rale)</li>
            <li>‚úÖ Interface: Suppression de la conduite professionnelle</li>
            <li>‚úÖ Temps: Formules corrig√©es pour les calculs de sobri√©t√©</li>
            <li>‚úÖ Coh√©rence: Synchronisation entre js/utils.js et test-bac.html</li>
        </ul>
    </div>
</body>
</html>
