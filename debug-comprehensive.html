<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Debug calculateComprehensiveStats</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 5px 0; border-radius: 3px; }
        .error { background: #ffe6e6; }
        .success { background: #e6ffe6; }
    </style>
</head>
<body>
    <h1>Debug calculateComprehensiveStats</h1>
    <div id="debug-output"></div>

    <script src="js/utils.js"></script>
    <script src="js/database.js"></script>
    <script src="js/stats-calculators/general.js"></script>
    <script src="js/stats-calculators/categories.js"></script>
    <script src="js/stats-calculators/drinks.js"></script>
    <script src="js/stats-calculators/health.js"></script>
    <script src="js/stats-calculators/temporal.js"></script>
    <script src="js/stats-calculators/location.js"></script>

    <script>
        const testData = {
            drinks: [
                {
                    id: 1,
                    name: 'Heineken',
                    category: 'Bière',
                    quantity: 1,
                    unit: 'EcoCup',
                    alcoholContent: 5,
                    date: '2025-09-29',
                    time: '18:00'
                }
            ],
            settings: { userWeight: 70, userGender: 'male' }
        };

        function debug(message, type = 'info') {
            const output = document.getElementById('debug-output');
            const div = document.createElement('div');
            div.className = `debug ${type}`;
            div.innerHTML = `${message}`;
            output.appendChild(div);
        }

        // Mock all dependencies
        window.dbManager = {
            getDrinksByDateRange: async (startDate, endDate) => {
                debug(`Mock: getDrinksByDateRange(${startDate}, ${endDate})`, 'success');
                return testData.drinks;
            },
            getAllSettings: async () => {
                debug('Mock: getAllSettings()', 'success');
                return testData.settings;
            },
            getAllDrinks: async () => {
                debug('Mock: getAllDrinks()', 'success');
                return testData.drinks;
            }
        };

        window.geoManager = {
            getLocationStats: async (drinks) => {
                debug(`Mock: geoManager.getLocationStats(${drinks.length} drinks)`, 'success');
                return { hasLocationData: false, message: 'Test', stats: null };
            }
        };

        async function testEachCalculator() {
            debug('=== Test de chaque calculateur individuellement ===');
            
            const drinks = testData.drinks;
            const dateRange = { start: '2025-09-29', end: '2025-09-29' };
            const settings = testData.settings;

            try {
                // Test 1: General
                debug('Test 1: General...');
                if (window.GeneralStatsCalculator) {
                    const general = await GeneralStatsCalculator.calculateGeneralStats(drinks, dateRange, { currentPeriod: 'today' });
                    debug(`✅ General: ${general.totalDrinks} boissons`, 'success');
                } else {
                    debug('❌ GeneralStatsCalculator manquant', 'error');
                }

                // Test 2: Categories
                debug('Test 2: Categories...');
                if (window.CategoryStatsCalculator) {
                    const categories = await CategoryStatsCalculator.calculateCategoryStats(drinks, dateRange);
                    debug(`✅ Categories: ${Object.keys(categories.categories).length} catégories`, 'success');
                } else {
                    debug('❌ CategoryStatsCalculator manquant', 'error');
                }

                // Test 3: Drinks
                debug('Test 3: Individual Drinks...');
                if (window.DrinkStatsCalculator) {
                    const drinkStats = await DrinkStatsCalculator.calculateDrinkStats(drinks, dateRange);
                    debug(`✅ Drinks: ${Object.keys(drinkStats.drinks).length} boissons uniques`, 'success');
                } else {
                    debug('❌ DrinkStatsCalculator manquant', 'error');
                }

                // Test 4: Health (MAINTENANT AVEC SETTINGS)
                debug('Test 4: Health...');
                if (window.HealthStatsCalculator) {
                    const health = await HealthStatsCalculator.calculateHealthStats(drinks, dateRange, { settings });
                    debug(`✅ Health: ${health.totalAlcoholGrams}g alcool`, 'success');
                } else {
                    debug('❌ HealthStatsCalculator manquant', 'error');
                }

                // Test 5: Temporal
                debug('Test 5: Temporal...');
                if (window.TemporalStatsCalculator) {
                    const temporal = await TemporalStatsCalculator.calculateTemporalStats(drinks, dateRange);
                    debug(`✅ Temporal: ${temporal.totalSessions} sessions`, 'success');
                } else {
                    debug('❌ TemporalStatsCalculator manquant', 'error');
                }

                // Test 6: Location
                debug('Test 6: Location...');
                if (window.LocationStatsCalculator) {
                    const location = await LocationStatsCalculator.calculateLocationStats(drinks, dateRange);
                    debug(`✅ Location: hasData=${location.hasLocationData}`, 'success');
                } else {
                    debug('❌ LocationStatsCalculator manquant', 'error');
                }

                debug('=== TOUS LES TESTS RÉUSSIS ===', 'success');

            } catch (error) {
                debug(`❌ ERREUR: ${error.message}`, 'error');
                console.error('Erreur complète:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(testEachCalculator, 1000);
        });
    </script>
</body>
</html>
