<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Démo Statistiques Modulaires - AlcoNote</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/responsive.css">
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            chtml: { scale: 1 }
        };
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <button class="menu-toggle" id="menu-toggle">☰</button>
            <h1 class="app-title">AlcoNote - Démo Statistiques</h1>
        </div>
    </header>

    <nav class="main-nav">
        <div class="nav-tabs">
            <button class="nav-tab">Catégories</button>
            <button class="nav-tab">Historique</button>
            <button class="nav-tab active" id="statistics-tab">Statistiques</button>
        </div>
    </nav>

    <main class="main-content">
        <div class="statistics-container">
            <!-- Period selector -->
            <div class="period-selector">
                <button class="period-btn active" data-period="today">Aujourd'hui</button>
                <button class="period-btn" data-period="week">Semaine</button>
                <button class="period-btn" data-period="month">Mois</button>
                <button class="period-btn" data-period="year">Année</button>
                <button class="period-btn" data-period="custom">Personnalisé</button>
            </div>

            <!-- Period navigation -->
            <div class="period-navigation active" id="period-navigation">
                <button class="nav-btn" id="prev-period">‹</button>
                <div class="period-display" id="current-period-display">dimanche 21 septembre 2025</div>
                <button class="nav-btn" id="next-period">›</button>
            </div>

            <!-- Statistics content -->
            <div class="statistics-content" id="statistics-content">
                <div class="loading-message">Chargement des statistiques...</div>
            </div>
        </div>
    </main>

    <script>
        // Données de démonstration
        const demoData = {
            drinks: [
                {
                    id: 1,
                    name: 'Heineken',
                    category: 'Bière',
                    quantity: 1,
                    unit: 'EcoCup',
                    alcoholContent: 5,
                    date: '2025-09-29',
                    time: '18:00',
                    latitude: 50.8503,
                    longitude: 4.3517,
                    address: 'Brussels, Belgium',
                    createdAt: new Date(),
                    updatedAt: new Date()
                },
                {
                    id: 2,
                    name: 'Stella Artois',
                    category: 'Bière',
                    quantity: 1,
                    unit: 'EcoCup',
                    alcoholContent: 5.2,
                    date: '2025-09-29',
                    time: '19:30',
                    latitude: 50.8503,
                    longitude: 4.3517,
                    address: 'Brussels, Belgium',
                    createdAt: new Date(),
                    updatedAt: new Date()
                },
                {
                    id: 3,
                    name: 'Chardonnay',
                    category: 'Vin',
                    quantity: 150,
                    unit: 'cL',
                    alcoholContent: 12.5,
                    date: '2025-09-29',
                    time: '20:15',
                    latitude: 50.8503,
                    longitude: 4.3517,
                    address: 'Brussels, Belgium',
                    createdAt: new Date(),
                    updatedAt: new Date()
                },
                {
                    id: 4,
                    name: 'Leffe Blonde',
                    category: 'Bière',
                    quantity: 1,
                    unit: 'EcoCup',
                    alcoholContent: 6.6,
                    date: '2025-09-28',
                    time: '17:45',
                    latitude: 50.8467,
                    longitude: 4.3525,
                    address: 'Antwerp, Belgium',
                    createdAt: new Date(),
                    updatedAt: new Date()
                },
                {
                    id: 5,
                    name: 'Whisky',
                    category: 'Spiritueux',
                    quantity: 4,
                    unit: 'cL',
                    alcoholContent: 40,
                    date: '2025-09-27',
                    time: '22:00',
                    latitude: 50.8467,
                    longitude: 4.3525,
                    address: 'Antwerp, Belgium',
                    createdAt: new Date(),
                    updatedAt: new Date()
                }
            ],
            settings: {
                userWeight: 70,
                userGender: 'male'
            }
        };

        // Mock Utils object FIRST
        window.Utils = {
            convertToStandardUnit: (quantity, unit) => {
                const conversions = {
                    'cL': 1,
                    'EcoCup': 25, // 25cL par EcoCup
                    'Demi': 25,
                    'Pinte': 50,
                    'L': 100
                };
                return {
                    quantity: quantity * (conversions[unit] || 1),
                    unit: 'cL'
                };
            },
            calculateAlcoholGrams: (volumeCL, alcoholPercent) => {
                return (volumeCL / 100) * (alcoholPercent / 100) * 0.8 * 1000; // 0.8 = densité éthanol
            },
            getCurrentDate: () => {
                return new Date().toISOString().split('T')[0];
            },
            formatDate: (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString('fr-FR', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            },
            formatQuantity: (quantity, unit) => {
                if (unit === 'EcoCup') return `${quantity} ${unit}`;
                return `${quantity}${unit}`;
            },
            getDayName: (dayIndex) => {
                const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                return days[dayIndex] || 'Inconnu';
            },
            addDays: (date, days) => {
                const result = new Date(date);
                result.setDate(result.getDate() + days);
                return result;
            },
            getDateRangeFixed: (period, currentDate) => {
                const date = new Date(currentDate);
                let start, end;
                
                switch (period) {
                    case 'today':
                        start = end = date.toISOString().split('T')[0];
                        break;
                    case 'week':
                        const dayOfWeek = date.getDay();
                        const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                        const monday = new Date(date);
                        monday.setDate(date.getDate() + mondayOffset);
                        const sunday = new Date(monday);
                        sunday.setDate(monday.getDate() + 6);
                        start = monday.toISOString().split('T')[0];
                        end = sunday.toISOString().split('T')[0];
                        break;
                    case 'month':
                        start = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
                        end = new Date(date.getFullYear(), date.getMonth() + 1, 0).toISOString().split('T')[0];
                        break;
                    case 'year':
                        start = `${date.getFullYear()}-01-01`;
                        end = `${date.getFullYear()}-12-31`;
                        break;
                    default:
                        start = end = date.toISOString().split('T')[0];
                }
                
                return { start, end };
            },
            showLoading: (container, message = 'Chargement...') => {
                if (container) {
                    container.innerHTML = `<div class="loading-message">${message}</div>`;
                }
                return { element: container };
            },
            hideLoading: (loading) => {
                if (loading && loading.element) {
                    // Ne pas effacer le contenu, juste indiquer que le loading est fini
                }
            },
            showMessage: (message, type = 'info') => {
                console.log(`${type.toUpperCase()}: ${message}`);
            },
            handleError: (error, context = '') => {
                console.error(`Error ${context}:`, error);
            },
            hexToRgba: (hex, alpha = 1) => {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            },
            getChartColors: (count) => {
                const colors = ['#007AFF', '#34C759', '#FF9500', '#FF3B30', '#5AC8FA', '#AF52DE', '#FF2D92', '#8E8E93'];
                return Array.from({length: count}, (_, i) => colors[i % colors.length]);
            },
            measureAsyncPerformance: async (label, asyncFn) => {
                console.log(`Performance: Starting ${label}`);
                const start = Date.now();
                try {
                    const result = await asyncFn();
                    const end = Date.now();
                    console.log(`Performance: ${label} completed in ${end - start}ms`);
                    return result;
                } catch (error) {
                    const end = Date.now();
                    console.error(`Performance: ${label} failed after ${end - start}ms:`, error);
                    throw error;
                }
            },
            calculateAverage: (numbers) => {
                if (!numbers || numbers.length === 0) return 0;
                return numbers.reduce((sum, num) => sum + num, 0) / numbers.length;
            },
            calculateBACStats: async (userWeight, userGender) => {
                // Mock BAC calculation - returning null to skip BAC section in demo
                console.log('Mock BAC calculation called for weight:', userWeight, 'gender:', userGender);
                return null;
            },
            formatTimeToSobriety: (hours) => {
                if (!hours || hours <= 0) return 'Maintenant';
                if (hours < 1) return `${Math.round(hours * 60)} min`;
                const h = Math.floor(hours);
                const m = Math.round((hours - h) * 60);
                return m > 0 ? `${h}h${m}min` : `${h}h`;
            },
            downloadFile: (content, filename) => {
                console.log('Mock download:', filename);
            }
        };

        // Mock dbManager SECOND
        window.dbManager = {
            getDrinksByDateRange: async (startDate, endDate) => {
                console.log(`Demo: Getting drinks between ${startDate} and ${endDate}`);
                const filteredDrinks = demoData.drinks.filter(drink => 
                    drink.date >= startDate && drink.date <= endDate
                );
                console.log(`Demo: Found ${filteredDrinks.length} drinks`, filteredDrinks);
                return filteredDrinks;
            },
            getAllSettings: async () => {
                console.log('Demo: Getting all settings');
                return demoData.settings;
            },
            getSetting: async (key) => {
                console.log(`Demo: Getting setting ${key}`);
                return demoData.settings[key] || null;
            },
            getAllDrinks: async () => {
                console.log('Demo: Getting all drinks');
                return demoData.drinks;
            }
        };

        // Mock geoManager THIRD
        window.geoManager = {
            getLocationStats: async (drinks) => {
                console.log('Demo: Mock geoManager.getLocationStats called with', drinks.length, 'drinks');
                const drinksWithLocation = drinks.filter(drink => drink.latitude && drink.longitude);
                console.log('Demo: Found', drinksWithLocation.length, 'drinks with location');
                return {
                    hasLocationData: drinksWithLocation.length > 0,
                    message: `${drinksWithLocation.length} boisson(s) avec localisation`,
                    stats: drinksWithLocation.length > 0 ? {
                        drinks: drinksWithLocation,
                        totalLocations: 2,
                        coverage: { percentage: Math.round((drinksWithLocation.length / drinks.length) * 100) }
                    } : null
                };
            },
            getCurrentPosition: async () => {
                console.log('Demo: Mock getCurrentPosition called');
                return {
                    coords: { latitude: 50.8503, longitude: 4.3517, accuracy: 50 },
                    latitude: 50.8503,
                    longitude: 4.3517,
                    accuracy: 50,
                    timestamp: Date.now(),
                    address: { formatted: 'Brussels, Belgium' }
                };
            }
        };
        
        // Mock Chart.js si pas disponible
        if (typeof Chart === 'undefined') {
            window.Chart = class MockChart {
                constructor(ctx, config) {
                    console.log('Mock Chart created with config:', config);
                    this.ctx = ctx;
                    this.config = config;
                    // Créer un canvas simple avec du texte
                    if (ctx && ctx.canvas) {
                        const canvas = ctx.canvas;
                        const context = canvas.getContext('2d');
                        context.fillStyle = '#f0f0f0';
                        context.fillRect(0, 0, canvas.width, canvas.height);
                        context.fillStyle = '#333';
                        context.font = '16px Arial';
                        context.textAlign = 'center';
                        context.fillText('Graphique indisponible (mode démo)', canvas.width/2, canvas.height/2);
                    }
                }
                destroy() {
                    console.log('Mock Chart destroyed');
                }
                update() {
                    console.log('Mock Chart updated');
                }
            };
        }

        // Mock Leaflet si pas disponible
        if (typeof L === 'undefined') {
            window.L = {
                map: function(id) {
                    console.log('Mock Leaflet map created for', id);
                    const element = document.getElementById(id);
                    if (element) {
                        element.innerHTML = '<div style="padding: 20px; background: #f0f0f0; text-align: center; color: #333;">Carte indisponible (mode démo)</div>';
                    }
                    return {
                        setView: () => this,
                        addLayer: () => this,
                        fitBounds: () => this,
                        setZoom: () => this,
                        hasLayer: () => false,
                        removeLayer: () => this,
                        off: () => this,
                        remove: () => this
                    };
                },
                tileLayer: function() {
                    return {
                        addTo: () => this
                    };
                },
                markerClusterGroup: function() {
                    return {
                        addLayer: () => this,
                        getBounds: () => ({ isValid: () => false, pad: () => this })
                    };
                },
                circleMarker: function() {
                    return {
                        bindPopup: () => this,
                        on: () => this,
                        setStyle: () => this
                    };
                }
            };
        }
    </script>

    <!-- Scripts - LOAD AFTER MOCKS -->
    <script src="js/utils.js"></script>
    <script src="js/statistics-new.js"></script>
    <script src="js/stats-config.js"></script>
    <!-- Chargement des calculateurs de statistiques -->
    <script src="js/stats-calculators/general.js"></script>
    <script src="js/stats-calculators/categories.js"></script>
    <script src="js/stats-calculators/drinks.js"></script>
    <script src="js/stats-calculators/health.js"></script>
    <script src="js/stats-calculators/temporal.js"></script>
    <script src="js/stats-calculators/location.js"></script>
    <!-- Chargement des renderers -->
    <script src="js/stats-renderers/general-renderer.js"></script>
    <script src="js/stats-renderers/category-renderer.js"></script>
    <script src="js/stats-renderers/drinks-renderer.js"></script>
    <script src="js/stats-renderers/health-renderer.js"></script>
    <script src="js/stats-renderers/temporal-renderer.js"></script>
    <script src="js/stats-renderers/location-renderer.js"></script>
    <!-- Gestionnaire principal -->
    <script src="js/statistics.js"></script>

    <script>
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initializing Demo Statistics...');
            
            // Pré-configurer la période et la date de référence pour afficher les données de démonstration
            if (window.modularStatsManager) {
                // Afficher la semaine autour des données de démo (2025-09-29)
                window.modularStatsManager.currentPeriod = 'week';
                window.modularStatsManager.currentDate = new Date('2025-09-29');
            }
            
            // Initialiser le gestionnaire de statistiques principal (prefer modular)
            if (window.modularStatsManager) {
                console.log('Using modular statistics manager');
                window.modularStatsManager.init();
            } else if (window.statsManager) {
                console.log('Using standard statistics manager');
                window.statsManager.init();
            } else {
                console.error('No statistics manager found');
            }
        });
    </script>
</body>
</html>
